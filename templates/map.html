{% extends "base.html" %}
{% block title %}Map View{% endblock %}

{% block content %}
<h2 style="text-align: center;">OpenStreetMap View</h2>

<!-- Map container -->
<div id="map" style="height: 900px; margin: 20px auto; width: 80%; border-radius: 10px;"></div>

<button onclick="openSplitEditor()" style="margin: 10px;">Create New Split</button>

<div id="splitEditor" style="display:none; padding: 15px; background: white; border: 1px solid black; margin: 20px;">
  <h3>Create a Split</h3>
  
  <label>Split Name:</label><br>
  <input type="text" id="splitNameInput"><br><br>

  <div id="sectorCheckboxes"></div>

  <br>
  <button onclick="confirmSplit()">Save Split</button>
  <button onclick="cancelSplitEditor()">Cancel</button>
</div>


<!-- Controller Splits List Container -->
<div id="controllerList" class="controller-list-container"></div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js">
</script>

<script>
  const cleCenter = [41.4117, -81.8498];
  const map = L.map('map').setView(cleCenter, 7);

  const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  });
  dark.addTo(map);

  const defaultStyle = {
    color: 'blue',
    weight: 2,
    fillOpacity: 0.2
  };

  const controllerColors = [
    '#4fc3f7', '#81c784', '#ffb74d', '#f06292',
    '#9575cd', '#aed581', '#fdd835', '#7986cb'
  ];

  const loadedSectors = {};
  const sectorToLayer = {};
  const availableSectors = [];

  function loadSector(url, options = {}) {
    fetch(url)
      .then(response => response.json())
      .then(data => {
        const geojson = L.geoJSON(data, {
          style: function () {
            return {
              color: options.color || defaultStyle.color,
              weight: defaultStyle.weight,
              fillOpacity: defaultStyle.fillOpacity
            };
          },
          onEachFeature: function (feature, layer) {
            const area = feature.properties.area || options.label || 'Unknown Area';
            const sector = feature.properties.sector || 'Unnamed Sector';
            const frequency = feature.properties.freq || '';
            const position = feature.properties.position || '';
            const id = `${area} - ${sector}`;

            

            availableSectors.push({
              id,
              area,
              sector,
              frequency,
              position,
              layer
            })

            layer.bindPopup(id);
            layer.on('click', function () {
              if (!editing) return;
              const currentController = controllers[currentControllerIndex];

              // Prevent duplicate sector assignments
              if (controllers.some(ctrl => ctrl.sectors.find(s => s.id === id))) return;

              const newSector = {
                id,
                layer,
                area,
                sector,
                frequency,
                position
              };

              currentController.sectors.push(newSector);
              layer.setStyle({
                color: currentController.color,
                weight: 3,
                fillOpacity: 0.6
              });
              renderControllerList();
            });

            sectorToLayer[id] = layer;
          }
        }).addTo(map);
        loadedSectors[url] = geojson;
      })
      .catch(error => {
        console.error("Failed to load sector:", url, error);
      });
  }

  // Add your geojson loads here
  loadSector('/static/sectors/high/a1h.geojson', { label: 'Area 1 High', color: 'green' });
  loadSector('/static/sectors/high/a2hpoly.geojson', { label: 'Area 2 High', color: 'green' });
  loadSector('/static/sectors/high/a3hpoly.geojson', { label: 'Area 3 High', color: 'green' });
  loadSector('/static/sectors/high/a4hpoly.geojson', { label: 'Area 4 High', color: 'green' });
  loadSector('/static/sectors/high/a5hpoly.geojson', { label: 'Area 5 High', color: 'green' });
  loadSector('/static/sectors/high/a6hpoly.geojson', { label: 'Area 6 High', color: 'green' });
  loadSector('/static/sectors/high/a7hpoly.geojson', { label: 'Area 7 High', color: 'green' });

</script>

<script>
  function openSplitEditor() {
  const container = document.getElementById('sectorCheckboxes');
  container.innerHTML = '';

  availableSectors.forEach(sector => {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = sector.id;
    checkbox.id = `sector-${sector.id}`;

    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.innerText = `${sector.sector} (${sector.frequency})`;

    container.appendChild(checkbox);
    container.appendChild(label);
    container.appendChild(document.createElement('br'));
  });

  document.getElementById('splitEditor').style.display = 'block';
}

function confirmSplit() {
  const selectedSectorIds = [];
  const selectedSectors = [];

  availableSectors.forEach(sector => {
    const checkbox = document.getElementById(`sector-${sector.id}`);
    if (checkbox.checked) {
      selectedSectorIds.push(sector.id);
      selectedSectors.push(sector);
    }
  });

  const splitName = document.getElementById('splitNameInput').value || "Unnamed Split";

  if (selectedSectors.length === 0) {
    alert("Select at least one sector!");
    return;
  }

  // Default primary sector is the first one
  const primarySector = selectedSectors[0];
  const primaryFrequency = primarySector.frequency;

  const newSplit = {
    name: splitName,
    primarySector: primarySector.sector,
    frequency: primaryFrequency,
    sectors: selectedSectorIds
  };

  console.log("Created Split:", newSplit);
  alert(`Created split "${splitName}" with ${selectedSectorIds.length} sectors.`);

  document.getElementById('splitEditor').style.display = 'none';

  // Later: add this new split to a display list or apply it
}

function cancelSplitEditor() {
  document.getElementById('splitEditor').style.display = 'none';
}

</script>

<script>
  fetch('/aircraft')
    .then(response => response.json())
    .then(data => {
        data.forEach(aircraft => {
            if (aircraft.lat && aircraft.lon) {

                // Define your ZOB airports array
                const zobAirports = ["KBUF", "KCLE", "KDTW", "KPIT"];

                // Check if departure or destination is in ZOB airports
                let isZobDeparture = zobAirports.includes(aircraft.departure);
                let isZobArrival = zobAirports.includes(aircraft.destination);

                // Set the circle color based on the ZOB match
                let circleColor = 'blue';  // Default color

                // If it's a ZOB departure, set color to 'red'
                if (isZobDeparture) {
                    circleColor = 'red';
                }
                // If it's a ZOB arrival, set color to 'yellow' (if it's not already 'red')
                else if (isZobArrival) {
                    circleColor = 'yellow';
                }

                // Create the circle and set the popup
                L.circle([aircraft.lat, aircraft.lon], {
                color: circleColor,
                fillColor: '#30f',
                fillOpacity: 0.5,
                radius: 300
                }).addTo(map)
                .bindTooltip(
                `${aircraft.callsign} ${aircraft.departure} ➔ ${aircraft.destination}`,
                {
                  sticky: true,
                  direction: 'top'
                }
                )
                .bindPopup(`
                    <div style="font-size: 16px; font-weight: bold;">
                        ${aircraft.callsign} ${aircraft.departure} ➔ ${aircraft.destination}
                    </div>
                    <div style="font-size: 13px; color: gray; margin-top: 5px; max-height: 100px; overflow-y: auto;">
                        ${aircraft.route}
                    </div>
                `);
            }
        });
    })
    .catch(error => console.error('Error fetching aircraft data:', error));


</script>

{% endblock %}
